### План взаимодействия уровней через запросы в системе с использованием Kafka:

1. **Прикладной уровень (Frontend)**:
   - **Запрос от прикладного уровня**: 
     - Прикладной уровень получает от пользователя сообщение, которое нужно отправить.
     - Это сообщение затем разбивается на сегменты (если оно слишком большое).
     - Каждый сегмент передается по одному на канальный уровень через Kafka.
   - **Тип запроса**: HTTP POST с сегментом сообщения.
     - Пример: `/send` (POST-запрос), где тело запроса содержит разбитое сообщение (сегмент).

2. **Канальный уровень**:
   - **Получение запроса от прикладного уровня**:
     - Канальный уровень получает сегменты через Kafka.
     - Каждое сообщение сегментируется на несколько частей. Канальный уровень получает и обрабатывает эти части.
   - **Тип запроса**: HTTP POST для передачи сегмента канальному серверу.
     - Пример: `/code` (POST-запрос), отправляемый на сервер канала. Он обрабатывает полученные данные и возвращает информацию о статусе.
   - **Обработка и сохранение сегмента**:
     - Канальный уровень собирает сегменты по порядку и обрабатывает их (например, проверяет целостность, качество или доставку).

3. **Kafka**:
   - **Producer**: Отправка сегментов сообщения в Kafka.
     - Запрос от прикладного уровня: Отправка сообщения как сегментов через Kafka (Producer отправляет).
   - **Consumer**: Получение сегментов сообщений из Kafka для дальнейшей обработки.
     - Запрос от канального уровня: Получение сообщений (сегментов) из Kafka (Consumer читает и собирает).
     - Consumer проверяет целостность сообщения и собирает сегменты. Если все сегменты пришли, сообщение собирается и отправляется обратно на прикладной уровень.

4. **Взаимодействие между уровнями через Kafka**:
   - **Producer → Kafka → Consumer**:
     - Прикладной уровень отправляет данные через Producer в Kafka, где эти данные разбиваются на сегменты.
     - Канальный уровень (Consumer) получает эти сегменты и начинает их обработку.

5. **Обработка и сборка сообщений**:
   - Канальный уровень получает все сегменты через Kafka и собирает их в одно сообщение.
   - Если все сегменты пришли, система собирает полное сообщение и отправляет его обратно на прикладной уровень.
   - Если какой-то сегмент потерян, система оповещает прикладной уровень об ошибке.

6. **Прикладной уровень получает собранное сообщение или ошибку**:
   - **Ошибка**: Если сообщение не может быть собрано (например, потеря сегмента), прикладной уровень получает ошибку.
   - **Готовое сообщение**: При успешной сборке сообщений, прикладной уровень получает полное сообщение, которое может быть отправлено пользователю.

---

### Пример взаимодействия по шагам:

1. **Прикладной уровень**:
   - Запрашивает сегментацию и отправку данных:
     - **Запрос**: HTTP POST на `/send`
     - **Тело запроса**: 
       ```json
       {
         "username": "user1",
         "text": "large message data",
         "send_time": "2025-03-29T10:00:00Z"
       }
       ```

2. **Kafka**:
   - Producer отправляет сегменты в Kafka:
     - Сообщение разбивается на части.
     - **Запрос**: Producer отправляет данные в Kafka по топику `segments`.
   - Consumer читает эти данные и передает их на канальный уровень.

3. **Канальный уровень**:
   - Получает данные через Kafka и обрабатывает их.
   - **Запрос**: HTTP POST на `/code`, где канальный уровень принимает каждый сегмент и выполняет свою логику (например, подтверждает получение).

4. **Сборка сообщений**:
   - После получения всех сегментов, канальный уровень собирает полное сообщение.
   - **Запрос**: HTTP POST на прикладной уровень `/receive`, передавая собранное сообщение или ошибку о потерянном сегменте.

5. **Прикладной уровень**:
   - Получает полное сообщение или ошибку о потере сегмента.
   - **Ответ**:
     - Успех: Сообщение собрано, прикладной уровень продолжает обработку.
     - Ошибка: Сообщение о потере сегмента, прикладной уровень повторяет попытку или оповещает пользователя.

---

### Техническое описание запросов и их ролей:

1. **HTTP POST на `/send` (Прикладной уровень → Канальный уровень)**:
   - **Цель**: Отправка сообщения через сегментацию.
   - **Тело запроса**: Сообщение, которое должно быть разбито на сегменты и передано на канальный уровень.

2. **Kafka Producer → Consumer (Канальный уровень)**:
   - **Цель**: Отправка и получение сообщений через Kafka.
   - Producer отправляет данные в Kafka по топику `segments`, Consumer читает сегменты и собирает их.

3. **HTTP POST на `/code` (Канальный уровень → Канальный сервер)**:
   - **Цель**: Отправка сегмента на канальный сервер для обработки.
   - **Тело запроса**: Сегмент с данными (номер сегмента, общий размер и т. д.).

4. **HTTP POST на `/receive` (Канальный уровень → Прикладной уровень)**:
   - **Цель**: Отправка собранного сообщения или ошибки о потере сегмента.
   - **Тело запроса**: Полное сообщение или информация о потере сегмента.

---

### Заключение:

Таким образом, взаимодействие между уровнями происходит через последовательность запросов, включая отправку данных через Kafka, обработку сообщений на канальном уровне, и сборку полных сообщений. При этом каждый уровень выполняет свою роль: прикладной уровень запускает процесс, Kafka отвечает за передачу данных, а канальный уровень обрабатывает сегменты и возвращает результат прикладному уровню.